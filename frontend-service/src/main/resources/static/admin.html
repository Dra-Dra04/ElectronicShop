<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Electro - Admin Dashboard</title>

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- Font Awesome Icon -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Montserrat', sans-serif; color: #333; background-color: #FBFBFC; }
        h1, h2, h3, h4, h5, h6 { color: #2B2D42; font-weight: 700; margin: 0 0 10px; }
        a { color: #2B2D42; transition: 0.2s color; }
        a:hover, a:focus { color: #D10024; text-decoration: none; outline: none; }

        /* Electro Theme Colors */
        .primary-color { color: #D10024; }

        /* Header */
        header { padding-bottom: 0; }
        #header { padding-top: 15px; padding-bottom: 15px; background-color: #15161D; }
        #top-header { padding-top: 10px; padding-bottom: 10px; background-color: #1E1F29; }
        .header-links li { display: inline-block; margin-right: 15px; font-size: 12px; }
        .header-links li a { color: #fff; }
        .header-links li i { color: #D10024; margin-right: 5px; }

        .header-logo .logo { display: block; }
        .header-logo .logo img { display: block; }

        /* Admin Section */
        .admin-section { padding-top: 30px; padding-bottom: 30px; }

        /* Sidebar Styling */
        .aside-title { text-transform: uppercase; font-size: 18px; margin-bottom: 30px; border-bottom: 1px solid #E4E7ED; padding-bottom: 10px; }
        .admin-sidebar .nav-pills > li { margin-top: 5px; }
        .admin-sidebar .nav-pills > li > a { border-radius: 0; color: #333; font-weight: 500; border-left: 3px solid transparent; }
        .admin-sidebar .nav-pills > li.active > a,
        .admin-sidebar .nav-pills > li.active > a:focus,
        .admin-sidebar .nav-pills > li.active > a:hover {
            background-color: #fff; color: #D10024; border-left-color: #D10024; box-shadow: 0px 0px 10px rgba(0,0,0,0.05);
        }
        .admin-sidebar .nav-pills > li > a:hover { background-color: #eee; }

        /* Stat Cards */
        .stat-card { background: #fff; padding: 20px; border: 1px solid #E4E7ED; margin-bottom: 20px; position: relative; overflow: hidden; }
        .stat-card .stat-icon { position: absolute; right: 10px; top: 10px; font-size: 40px; color: #e4e7ed; z-index: 1; }
        .stat-card .stat-number { font-size: 24px; font-weight: 700; color: #D10024; position: relative; z-index: 2; margin-bottom: 5px; }
        .stat-card .stat-label { font-size: 14px; text-transform: uppercase; font-weight: 500; position: relative; z-index: 2; }

        /* Buttons & Tables */
        .btn-red { background-color: #D10024; color: #fff; border: none; border-radius: 40px; padding: 10px 20px; font-weight: 700; text-transform: uppercase; font-size: 13px; transition: 0.2s all; cursor: pointer; }
        .btn-red:hover { background-color: #333; color: #fff; }
        .table > thead > tr > th { border-bottom: 2px solid #E4E7ED; font-weight: 700; text-transform: uppercase; font-size: 12px; }
        .table-hover tbody tr:hover { background-color: #f9f9f9; }
        .table { background: #fff; }

        /* Forms */
        .admin-form-group { margin-bottom: 15px; }
        .admin-form-group label { font-weight: 500; margin-bottom: 5px; font-size: 12px; text-transform: uppercase; }
        .input { height: 40px; padding: 0px 15px; border: 1px solid #E4E7ED; background-color: #FFF; width: 100%; }
        textarea.input { padding: 10px 15px; }

        /* Tab Content */
        .tab-content { background: #fff; border: 1px solid #E4E7ED; padding: 30px; min-height: 500px; }
        .section-title { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #E4E7ED; text-transform: uppercase; font-weight: 700; font-size: 18px; }

        /* Footer */
        #footer { background: #15161D; color: #B9BABC; padding-top: 30px; }
        .footer-title { color: #FFF; text-transform: uppercase; font-size: 18px; margin: 0 0 30px; }
        .footer-links li + li { margin-top: 15px; }
        .footer-links li a { color: #B9BABC; }
        .footer-links li a:hover { color: #D10024; }
        .copyright { margin-top: 30px; display: block; font-size: 12px; margin-bottom: 30px;}

        /* Modal Overrides */
        .modal-header { border-bottom: 1px solid #E4E7ED; }
        .modal-footer { border-top: 1px solid #E4E7ED; }
    </style>
</head>
<body>
<!-- HEADER -->
<header>
    <!-- TOP HEADER -->
    <div id="top-header">
        <div class="container">
            <ul class="header-links pull-left">
                <li><a href="#"><i class="fa fa-phone"></i> +021-95-51-84</a></li>
                <li><a href="#"><i class="fa fa-envelope-o"></i> admin@electro.com</a></li>
                <li><a href="#"><i class="fa fa-map-marker"></i> 1734 Stonecoal Road</a></li>
            </ul>
            <ul class="header-links pull-right">
                <li><a href="#"><i class="fa fa-user-secret"></i> Admin Panel</a></li>
                <li><a href="store.html"><i class="fa fa-sign-out"></i> Logout</a></li>
            </ul>
        </div>
    </div>
    <!-- /TOP HEADER -->

    <!-- MAIN HEADER -->
    <div id="header">
        <!-- container -->
        <div class="container">
            <!-- row -->
            <div class="row">
                <!-- LOGO -->
                <div class="col-md-3">
                    <div class="header-logo">
                        <a href="#" class="logo">
                            <h2 style="color: #FFF; margin-top: 10px;">ELECTRO<span style="color: #D10024;">.</span></h2>
                        </a>
                    </div>
                </div>
                <!-- /LOGO -->

                <!-- Admin Title -->
                <div class="col-md-9 text-right" style="padding-top: 15px;">
                    <h3 style="color: #fff; margin: 0;">ADMIN DASHBOARD</h3>
                </div>
            </div>
            <!-- row -->
        </div>
        <!-- container -->
    </div>
    <!-- /MAIN HEADER -->
</header>
<!-- /HEADER -->

<!-- ADMIN SECTION -->
<div class="section admin-section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">

            <!-- SIDEBAR MENU -->
            <div class="col-md-3">
                <div class="aside">
                    <h3 class="aside-title">Management</h3>
                    <ul class="nav nav-pills nav-stacked admin-sidebar">
                        <li class="active"><a data-toggle="pill" href="#dashboard"><i class="fa fa-tachometer"></i> Dashboard</a></li>
                        <li><a data-toggle="pill" href="#products"><i class="fa fa-cube"></i> Products</a></li>
                        <li><a data-toggle="pill" href="#categories"><i class="fa fa-tags"></i> Categories & Brands</a></li>
                        <li><a data-toggle="pill" href="#orders"><i class="fa fa-shopping-cart"></i> Orders</a></li>
                        <li><a data-toggle="pill" href="#users"><i class="fa fa-users"></i> Users</a></li>
                    </ul>
                </div>
            </div>
            <!-- /SIDEBAR MENU -->

            <!-- MAIN CONTENT -->
            <div class="col-md-9">
                <div class="tab-content">

                    <!-- TAB: DASHBOARD -->
                    <div id="dashboard" class="tab-pane fade in active">
                        <h3 class="section-title">Overview</h3>
                        <div class="row">
                            <div class="col-md-3 col-xs-6">
                                <div class="stat-card">
                                    <i class="fa fa-shopping-cart stat-icon"></i>
                                    <!-- UPDATED: dùng ID để JS set số Orders -->
                                    <div class="stat-number" id="stat-orders">-</div>
                                    <div class="stat-label">Orders</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-xs-6">
                                <div class="stat-card">
                                    <i class="fa fa-dollar stat-icon"></i>
                                    <!-- UPDATED: dùng ID để JS set doanh thu -->
                                    <div class="stat-number" id="stat-revenue">-</div>
                                    <div class="stat-label">Revenue</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-xs-6">
                                <div class="stat-card">
                                    <i class="fa fa-users stat-icon"></i>
                                    <!-- UPDATED: dùng ID để JS set Users -->
                                    <div class="stat-number" id="stat-users">-</div>
                                    <div class="stat-label">Users</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-xs-6">
                                <div class="stat-card">
                                    <i class="fa fa-cube stat-icon"></i>
                                    <!-- UPDATED: dùng ID để JS set Products -->
                                    <div class="stat-number" id="stat-products">-</div>
                                    <div class="stat-label">Products</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: PRODUCTS -->
                    <div id="products" class="tab-pane fade">
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col-md-6">
                                <h3 class="section-title" style="border:none; margin:0;">Product List</h3>
                            </div>
                            <div class="col-md-6 text-right">
                                <button class="btn-red" data-toggle="modal" data-target="#addProductModal">
                                    <i class="fa fa-plus"></i> Add Product
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <!-- UPDATED: xoá dữ liệu fake, để tbody trống và JS sẽ fill -->
                                <tbody id="product-table-body">
                                <!-- ADDED: rows will be injected by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: CATEGORIES & BRANDS -->
                    <div id="categories" class="tab-pane fade">
                        <h3 class="section-title">Categories & Brands Management</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="billing-details">
                                    <div class="section-title">
                                        <h4 class="title">Add New Brand</h4>
                                    </div>
                                    <div class="admin-form-group">
                                        <input id="brand-name-input" class="input" type="text" name="brand-name" placeholder="Brand Name">
                                    </div>
                                    <button class="btn-red" id="btn-add-brand"><i class="fa fa-plus"></i> Add Brand</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="billing-details">
                                    <div class="section-title">
                                        <h4 class="title">Add Categories</h4>
                                    </div>
                                    <div class="admin-form-group">
                                        <input id="category-name-input" class="input" type="text" name="manu-name" placeholder="Category Name">
                                    </div>
                                    <button class="btn-red" id="btn-add-category"><i class="fa fa-plus"></i> Add Categories</button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h4>Existing Brands</h4>
                        <!-- UPDATED: tbody có id, dữ liệu sẽ lấy từ API sau này -->
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Product Count</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="brand-table-body">
                            <!-- ADDED: brand rows will be injected by JS (hiện tại có thể để trống hoặc fake) -->
                            </tbody>
                        </table>
                    </div>

                    <!-- TAB: ORDERS -->
                    <div id="orders" class="tab-pane fade">
                        <h3 class="section-title">Order Management</h3>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <!-- ADDED: tbody với id để sau này load Orders bằng API -->
                                <tbody id="order-table-body">
                                <!-- TODO: load orders from /api/admin/orders -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: USERS -->
                    <div id="users" class="tab-pane fade">
                        <h3 class="section-title">User Management</h3>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <!-- ADDED: tbody với id để sau này load Users bằng API -->
                                <tbody id="user-table-body">
                                <!-- TODO: load users from /api/admin/users -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
            <!-- /MAIN CONTENT -->

        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /ADMIN SECTION -->

<!-- MODAL: ADD PRODUCT -->
<div id="addProductModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Thêm sản phẩm mới</h4>
            </div>
            <div class="modal-body">
                <!-- UPDATED: thêm id cho form & các input để lấy dữ liệu bằng JS -->
                <form id="add-product-form">
                    <div class="admin-form-group">
                        <label>Tên sản phẩm</label>
                        <input id="product-name-input" class="input" type="text" placeholder="Enter product name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Giá tiền</label>
                                <input id="product-price-input" class="input" type="number" min="0" step="1000" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Số lượng</label>
                                <input id="product-stock-input" class="input" type="number" min="0" placeholder="0" required>
                            </div>
                        </div>
                    </div>

                    <!-- BRAND & CATEGORIES SELECTS -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Brand</label>
                                <select id="product-brand-select" class="input">
                                    <option value="">Chọn thương hiệu</option>
                                    <!-- options sẽ được load từ API /brands -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label> Category</label>
                                <select id="product-category-select" class="input">
                                    <option value="">Chọn loại sản phẩm</option>
                                    <!-- options sẽ được load từ API /categories -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="admin-form-group">
                        <label>Mô tả</label>
                        <textarea id="product-description-input" class="input" style="height: 100px;" placeholder="Product description..."></textarea>
                    </div>
                    <div class="admin-form-group">
                        <label>Ảnh chính (Main Image URL)</label>
                        <input id="product-main-image-url-input" type="text" class="input"
                               placeholder="https://example.com/main-image.jpg">
                    </div>

                    <div class="admin-form-group">
                        <label>Ảnh phụ (mỗi dòng 1 URL)</label>
                        <textarea id="product-extra-images-input" class="input" style="height: 80px;"
                                  placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
                        <small class="text-muted">Mỗi dòng là 1 URL ảnh. Ảnh đầu tiên sẽ được dùng làm thumbnail nếu không có ảnh chính.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <!-- UPDATED: nút Update gọi JS addProduct() -->
                <button type="button" class="btn btn-red" id="btn-save-product">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- EDIT PRODUCT -->
<!-- MODAL: EDIT PRODUCT -->
<div id="editProductModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Chỉnh sửa sản phẩm</h4>
            </div>
            <div class="modal-body">
                <form id="edit-product-form">
                    <!-- Ẩn ID sản phẩm -->
                    <input type="hidden" id="edit-product-id">

                    <div class="admin-form-group">
                        <label>Tên sản phẩm</label>
                        <input id="edit-product-name-input" class="input" type="text" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Giá tiền</label>
                                <input id="edit-product-price-input" class="input" type="number" min="0" step="1000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Số lượng</label>
                                <input id="edit-product-stock-input" class="input" type="number" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Thương hiệu</label>
                                <select id="edit-product-brand-select" class="input">
                                    <option value="">Chọn thương hiệu</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="admin-form-group">
                                <label>Category</label>
                                <select id="edit-product-category-select" class="input">
                                    <option value="">Chọn loại sản phẩm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="admin-form-group">
                        <label>Mô tả</label>
                        <textarea id="edit-product-description-input" class="input" style="height:100px;"></textarea>
                    </div>

                    <div class="admin-form-group">
                        <label>Ảnh chính (Main Image URL)</label>
                        <input id="edit-product-main-image-url-input" type="text" class="input">
                    </div>

                    <div class="admin-form-group">
                        <label>Ảnh phụ (mỗi dòng 1 URL)</label>
                        <textarea id="edit-product-extra-images-input" class="input" style="height:80px;"></textarea>
                        <small class="text-muted">Mỗi dòng là 1 URL. Ảnh chính nằm ở ô trên.</small>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-red" id="btn-update-product">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer id="footer">
    <!-- top footer -->
    <div class="section">
        <!-- container -->
        <div class="container">
            <!-- row -->
            <div class="row">
                <div class="col-md-3 col-xs-6">
                    <div class="footer">
                        <h3 class="footer-title">About Us</h3>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut.</p>
                        <ul class="footer-links">
                            <li><a href="#"><i class="fa fa-map-marker"></i>1734 Stonecoal Road</a></li>
                            <li><a href="#"><i class="fa fa-phone"></i>+021-95-51-84</a></li>
                            <li><a href="#"><i class="fa fa-envelope-o"></i>email@email.com</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-3 col-xs-6">
                    <div class="footer">
                        <h3 class="footer-title">Admin Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">System Health</a></li>
                            <li><a href="#">Error Logs</a></li>
                            <li><a href="#">API Documentation</a></li>
                        </ul>
                    </div>
                </div>

                <div class="clearfix visible-xs"></div>

                <div class="col-md-3 col-xs-6">
                    <div class="footer">
                        <h3 class="footer-title">Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="#">View Storefront</a></li>
                            <li><a href="#">Analytics</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-3 col-xs-6">
                    <div class="footer">
                        <h3 class="footer-title">Account</h3>
                        <ul class="footer-links">
                            <li><a href="#">Admin Profile</a></li>
                            <li><a href="#">Settings</a></li>
                            <li><a href="#">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /row -->
        </div>
        <!-- /container -->
    </div>
    <!-- /top footer -->

    <!-- bottom footer -->
    <div id="bottom-footer" class="section">
        <div class="container">
            <!-- row -->
            <div class="row">
                <div class="col-md-12 text-center">
							<span class="copyright">
								Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | Template by Colorlib
							</span>
                </div>
            </div>
            <!-- /row -->
        </div>
        <!-- /container -->
    </div>
    <!-- /bottom footer -->
</footer>
<!-- /FOOTER -->

<!-- jQuery & Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<!-- ADDED: JavaScript gọi API admin-service -->
<script>
    const ADMIN_API_BASE = 'http://localhost:8085/api/admin';

    // Khi trang load xong
    $(document).ready(function () {
    loadDashboardStats();
    loadProducts();
    loadBrands();
    loadCategories();
    loadUsers();

    // Save new product
    $('#btn-save-product').on('click', function () {
        addProduct();
    });

    // Add new brand
    $('#btn-add-brand').on('click', function () {
        createBrand();
    });

    // Add new category
    $('#btn-add-category').on('click', function () {
        createCategory();
    });

    // Update product
    $('#btn-update-product').on('click', function () {
        updateProduct();
    });
    });

    // -------- DASHBOARD --------
    function loadDashboardStats() {
        $.get(ADMIN_API_BASE + '/dashboard/overview')
            .done(function (data) {
                // data = {totalOrders, totalUsers, totalProducts, totalRevenue}
                $('#stat-orders').text(data.totalOrders);
                $('#stat-users').text(data.totalUsers);
                $('#stat-products').text(data.totalProducts);

                // Format revenue đơn giản
                const formattedRevenue = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(data.totalRevenue || 0);

                $('#stat-revenue').text(formattedRevenue);
            })
            .fail(function () {
                console.error('Failed to load dashboard stats');
            });
    }

    // -------- PRODUCTS LIST --------
    function loadProducts() {
    $.get(ADMIN_API_BASE + '/products')
        .done(function (products) {
            const $tbody = $('#product-table-body');
            $tbody.empty();

            if (!products || products.length === 0) {
                $tbody.append(
                    '<tr><td colspan="6" class="text-center">No products found</td></tr>'
                );
                return;
            }

            products.forEach(function (p) {
                const priceFormatted = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(p.price || 0);

                let stockLabelClass = 'label-success';
                let stockText = 'Còn hàng';
                if (p.stock === 0) {
                    stockLabelClass = 'label-danger';
                    stockText = 'Hết hàng';
                } else if (p.stock < 5) {
                    stockLabelClass = 'label-warning';
                    stockText = 'Sắp hết';
                }

                // Lấy thumbnail: ưu tiên imageUrl, sau đó tới images[0]
                let thumbUrl = p.imageUrl;
                if ((!thumbUrl || thumbUrl === '') && p.images && p.images.length > 0) {
                    const mainImg = p.images.find(i => i.isMain) || p.images[0];
                    thumbUrl = mainImg.imageUrl;
                }

                const rowHtml = `
                    <tr>
                        <td>#${p.id}</td>
                        <td>
                            <div style="width:50px; height:50px; background:#eee; display:flex; align-items:center; justify-content:center;">
                                ${thumbUrl
                    ? '<img src="' + thumbUrl + '" style="max-width:100%; max-height:100%;" />'
                    : '<i class="fa fa-picture-o"></i>'}
                            </div>
                        </td>
                        <td>${p.name || ''}</td>
                        <td>${priceFormatted}</td>
                        <td><span class="label ${stockLabelClass}">${stockText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-default" onclick="editProduct(${p.id})"><i class="fa fa-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})"><i class="fa fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                $tbody.append(rowHtml);
            });
        })
        .fail(function () {
            console.error('Failed to load products');
        });
        }

    // -------- ADD PRODUCT --------
    function addProduct() {
    const name = $('#product-name-input').val().trim();
    const price = parseFloat($('#product-price-input').val());
    const stock = parseInt($('#product-stock-input').val(), 10);
    const brandId = $('#product-brand-select').val() || null;
    const categoryId = $('#product-category-select').val() || null;
    const description = $('#product-description-input').val().trim();

    const mainImageUrl = $('#product-main-image-url-input').val().trim();
    const extraImagesRaw = $('#product-extra-images-input').val();

    if (!name || isNaN(price) || isNaN(stock)) {
        alert('Vui lòng nhập đầy đủ Tên, Giá và Số lượng');
        return;
    }

    // Chuẩn bị mảng images cho backend (ProductImage)
    const images = [];
    let imageUrlField = null; // giữ ảnh chính để map vào Product.imageUrl (nếu backend vẫn dùng)

    if (mainImageUrl) {
        images.push({
            imageUrl: mainImageUrl,
            isMain: true,
            sortOrder: 0
        });
        imageUrlField = mainImageUrl;
    }

    if (extraImagesRaw && extraImagesRaw.trim().length > 0) {
        const lines = extraImagesRaw.split(/\r?\n/);
        lines.forEach(function (line) {
            const url = line.trim();
            if (url) {
                images.push({
                    imageUrl: url,
                    isMain: false,
                    sortOrder: images.length // tiếp tục thứ tự
                });
            }
        });
    }

    const payload = {
        name: name,
        price: price,
        stock: stock,
        brandId: brandId ? parseInt(brandId, 10) : null,
        categoryId: categoryId ? parseInt(categoryId, 10) : null,
        description: description,
        imageUrl: imageUrlField, // để product-service map vào Product.imageUrl
        images: images          // để map sang List<ProductImage>
    };

    $.ajax({
        url: ADMIN_API_BASE + '/products',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function () {
            $('#addProductModal').modal('hide');
            $('#add-product-form')[0].reset();
            $('#product-extra-images-input').val('');
            loadProducts();
        },
        error: function () {
            alert('Thêm sản phẩm thất bại. Kiểm tra lại backend admin-service / product-service.');
        }
    });
}

    // -------- BRANDS --------
    function loadBrands() {
        $.get(ADMIN_API_BASE + '/brands')
            .done(function (brands) {
                const $tbody = $('#brand-table-body');
                const $selectAdd = $('#product-brand-select');
                const $selectEdit = $('#edit-product-brand-select');

                $tbody.empty();
                $selectAdd.find('option:not(:first)').remove();
                $selectEdit.find('option:not(:first)').remove();

                if (!brands || brands.length === 0) {
                    $tbody.append('<tr><td colspan="4" class="text-center">No brands</td></tr>');
                    return;
                }

                brands.forEach(function (b) {
                    // Table
                    const rowHtml = `
                        <tr>
                            <td>${b.id}</td>
                            <td>${b.name}</td>
                            <td>${b.productCount || 0}</td>
                            <td>
                                <!-- tuỳ bạn muốn thêm Edit/Delete brand -->
                            </td>
                        </tr>
                    `;
                    $tbody.append(rowHtml);

                    // Select (Add + Edit)
                    const option = `<option value="${b.id}">${b.name}</option>`;
                    $selectAdd.append(option);
                    $selectEdit.append(option);
                });
            })
            .fail(function () {
                console.error('Failed to load brands');
            });
    }

    function createBrand() {
        const name = $('#brand-name-input').val().trim();
        if (!name) {
            alert('Vui lòng nhập tên Brand');
            return;
        }

        $.ajax({
            url: ADMIN_API_BASE + '/brands',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name }),
            success: function () {
                $('#brand-name-input').val('');
                loadBrands();
            },
            error: function () {
                alert('Tạo brand thất bại. Kiểm tra API POST /brands');
            }
        });
    }

    // -------- CATEGORIES --------
    function loadCategories() {
        $.get(ADMIN_API_BASE + '/categories')
            .done(function (categories) {
                const $selectAdd = $('#product-category-select');
                const $selectEdit = $('#edit-product-category-select');

                $selectAdd.find('option:not(:first)').remove();
                $selectEdit.find('option:not(:first)').remove();

                if (!categories || categories.length === 0) {
                    return;
                }

                categories.forEach(function (c) {
                    const option = `<option value="${c.id}">${c.name}</option>`;
                    $selectAdd.append(option);
                    $selectEdit.append(option);
                });
            })
            .fail(function () {
                console.error('Failed to load categories');
            });
    }

    function createCategory() {
        const name = $('#category-name-input').val().trim();
        if (!name) {
            alert('Vui lòng nhập tên Category');
            return;
        }

        $.ajax({
            url: ADMIN_API_BASE + '/categories',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name }),
            success: function () {
                $('#category-name-input').val('');
                loadCategories();
            },
            error: function () {
                alert('Tạo category thất bại. Kiểm tra API POST /categories');
            }
        });
    }

    // -------- EDIT PRODUCT --------
    function editProduct(id) {
        // Lấy full thông tin product từ backend
        $.get(ADMIN_API_BASE + '/products/' + id)
            .done(function (p) {
                // Đảm bảo brand & category đã load
                // (nếu đang load chưa xong thì setTimeout 1 chút, nhưng tạm coi đã có)
                $('#edit-product-id').val(p.id);
                $('#edit-product-name-input').val(p.name || '');
                $('#edit-product-price-input').val(p.price || 0);
                $('#edit-product-stock-input').val(p.stock || 0);
                $('#edit-product-description-input').val(p.description || '');

                if (p.brandId) {
                    $('#edit-product-brand-select').val(p.brandId);
                }
                if (p.categoryId) {
                    $('#edit-product-category-select').val(p.categoryId);
                }

                // Xử lý images
                let mainImageUrl = p.imageUrl || '';
                let extraImages = [];

                if (p.images && p.images.length > 0) {
                    const mainImg = p.images.find(i => i.isMain) || null;
                    if (mainImg) {
                        mainImageUrl = mainImg.imageUrl;
                    }
                    extraImages = p.images
                        .filter(i => !i.isMain)
                        .map(i => i.imageUrl);
                }

                $('#edit-product-main-image-url-input').val(mainImageUrl || '');
                $('#edit-product-extra-images-input').val(extraImages.join('\n'));

                $('#editProductModal').modal('show');
            })
            .fail(function () {
                alert('Không load được thông tin sản phẩm #' + id);
            });
    }

    function updateProduct() {
        const id = $('#edit-product-id').val();
        const name = $('#edit-product-name-input').val().trim();
        const price = parseFloat($('#edit-product-price-input').val());
        const stock = parseInt($('#edit-product-stock-input').val(), 10);
        const brandId = $('#edit-product-brand-select').val() || null;
        const categoryId = $('#edit-product-category-select').val() || null;
        const description = $('#edit-product-description-input').val().trim();

        const mainImageUrl = $('#edit-product-main-image-url-input').val().trim();
        const extraImagesRaw = $('#edit-product-extra-images-input').val();

        if (!name || isNaN(price) || isNaN(stock)) {
            alert('Vui lòng nhập đầy đủ Tên, Giá và Số lượng');
            return;
        }

        const images = [];
        let imageUrlField = null;

        if (mainImageUrl) {
            images.push({
                imageUrl: mainImageUrl,
                isMain: true,
                sortOrder: 0
            });
            imageUrlField = mainImageUrl;
        }

        if (extraImagesRaw && extraImagesRaw.trim().length > 0) {
            const lines = extraImagesRaw.split(/\r?\n/);
            lines.forEach(function (line) {
                const url = line.trim();
                if (url) {
                    images.push({
                        imageUrl: url,
                        isMain: false,
                        sortOrder: images.length
                    });
                }
            });
        }

        const payload = {
            name: name,
            price: price,
            stock: stock,
            brandId: brandId ? parseInt(brandId, 10) : null,
            categoryId: categoryId ? parseInt(categoryId, 10) : null,
            description: description,
            imageUrl: imageUrlField,
            images: images
        };

        $.ajax({
            url: ADMIN_API_BASE + '/products/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function () {
                $('#editProductModal').modal('hide');
                loadProducts();
            },
            error: function () {
                alert('Cập nhật sản phẩm thất bại.');
            }
        });
    }
    // -------- DELETE PRODUCT  --------

    function deleteProduct(id) {
        if (!confirm('Bạn có chắc muốn xoá sản phẩm #' + id + ' ?')) {
            return;
        }

        $.ajax({
            url: ADMIN_API_BASE + '/products/' + id,
            method: 'DELETE',
            success: function () {
                loadProducts();
            },
            error: function () {
                alert('Xoá sản phẩm thất bại. Kiểm tra lại backend.');
            }
        });
    }
    // ========== USERS ==========
    function loadUsers(role) {
        let url = ADMIN_API_BASE + '/users';
        if (role) {
            url += '?role=' + role;
        }

        $.get(url)
            .done(function (users) {
                const $tbody = $('#user-table-body');
                $tbody.empty();

                if (!users || users.length === 0) {
                    $tbody.append(
                        '<tr><td colspan="6" class="text-center">No users found</td></tr>'
                    );
                    return;
                }

                users.forEach(function (u) {
                    const statusLabel = u.active
                        ? '<span class="label label-success">Active</span>'
                        : '<span class="label label-default">Inactive</span>';

                    const rowHtml = `
                        <tr>
                            <td>#${u.id}</td>
                            <td>${u.fullName || ''}</td>
                            <td>${u.email || ''}</td>
                            <td>${u.role || ''}</td>
                            <td>${statusLabel}</td>
                            <td>
                                <button class="btn btn-sm btn-default" onclick="viewUser(${u.id})">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    $tbody.append(rowHtml);
                });
            })
            .fail(function () {
                console.error('Failed to load users');
                alert('Không tải được danh sách user. Kiểm tra lại admin-service / customer-service.');
            });
    }

    function deleteUser(id) {
        if (!confirm('Bạn có chắc muốn xoá user #' + id + ' ?')) {
            return;
        }

        $.ajax({
            url: ADMIN_API_BASE + '/users/' + id,
            method: 'DELETE',
            success: function () {
                loadUsers();
            },
            error: function () {
                alert('Xoá user thất bại. Kiểm tra lại backend.');
            }
        });
    }

    function viewUser(id) {
        $.get(ADMIN_API_BASE + '/users/' + id)
            .done(function (u) {
                alert(
                    'User #' + u.id +
                    '\nTên: ' + (u.fullName || '') +
                    '\nEmail: ' + (u.email || '') +
                    '\nPhone: ' + (u.phone || '') +
                    '\nĐịa chỉ: ' + (u.address || '') +
                    '\nRole: ' + (u.role || '') +
                    '\nActive: ' + (u.active ? 'Yes' : 'No')
                );
            })
            .fail(function () {
                alert('Không load được chi tiết user');
            });
    }

</script>

</body>
</html>
